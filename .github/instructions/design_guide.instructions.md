---
applyTo: "**"
---
# Design Guide for DaliMaster
# Collaboration Notice
To facilitate collaboration, the prompt file must be written in English.

# Issue check
- Use `flutter analyze` to get the list of files with issues. Then, for each file, use the problems tool to check for specific problems.

# Test
- Use `flutter test` to run the test suite.
- Aim for high test coverage, especially for critical components.

# API Deprecation Guide
File path: `.github/prompts/deprecated_api_guide.prompt.md`
This file is used for guidance on deprecated APIs. When correcting errors related to deprecated APIs, always check the latest documentation online first. Then, document the API changes and important notes in this file for future reference.


## Repository layout

Use this repository structure when navigating, building automation, or proposing changes. Keep this section in sync when directories are added/removed.

- Change management requirement: When creating, renaming, moving, or deleting files/folders, you MUST update this instructions.md in the same PR to keep the structure and responsibilities accurate. Reviewers should verify this as a checklist item.

- Root
	- `lib/` — Flutter app source code
		- `main.dart` — Application entrypoint; initializes dependencies, routing, localization, themes, root widgets.
		- `firebase_options.dart` — Generated Firebase configuration (do not edit; regenerated by FlutterFire CLI).
		- `toast.dart` — Lightweight toast helpers.
		- `auth/` — Casdoor integration, auth services and config (login/logout, token refresh, user profile).
		- `connection/` — Device connection layer (USB/BLE/IP/Mock). Files:
			- `connection.dart` — Abstract Connection interface (connect/send/read/scan/UI hooks).
			- `manager.dart` — Singleton ConnectionManager; selects method (BLE/IP/USB/Mock), detects gateway type, tracks bus status, opens IP dialog, persists preferences.
			- `ble.dart` — BLE implementation (scan/connect/notify, permissions, rename device dialog, bus-abnormal monitor for type0 gateways).
			- `ble_web.dart` — Web-specific BLE glue (if applicable on Web builds).
			- `serial_platform.dart` — Conditional factory for serial connections via platform imports.
			- `serial_impl_io.dart` | `serial_impl_web.dart` | `serial_impl_stub.dart` — Platform-specific creation and support checks for serial.
			- `serial_usb.dart` — Desktop USB serial via flutter_libserialport (scan, connect, buffered read, auto-reconnect, port monitoring).
			- `serial_ip.dart` — TCP/UDP clients with buffered reads, connect/disconnect lifecycle, basic error handling.
			- `serial_web.dart` — Web Serial implementation (if applicable on Web builds).
			- `mock.dart` — Simulated connection for tests/training; mock DALI bus/devices, JSON import/export, strict selection modes.
			- `mock_bus.dart` — Mock bus and device models used by `mock.dart`.
		- `dali/` — DALI protocol stack and helpers. Files:
			- `dali.dart` — Facade aggregating core components (base/addr/dt1/dt8/decode) and binding ConnectionManager.
			- `base.dart` — High-level DALI operations (on/off, brightness, scenes, groups, DT8 helpers, queries) built on `comm.dart`.
			- `comm.dart` — Low-level gateway frames (0x10/0x11/0x12 and legacy), retries/delays, read/write plumbing, error handling.
			- `addr.dart` — Addressing and discovery: compare, allocate short addresses, scan ranges, with streams for UI.
			- `dt1.dart` — DT1 behaviors and queries (device-type specific helpers for basic gear).
			- `dt8.dart` — DT8 color control helpers (xy, color temperature, rgb mappings).
			- `color.dart` — Color utilities for DALI DT8; follow the Deprecated API Guide for Color (use r/g/b/a doubles, not red/green/blue/alpha ints).
			- `decode.dart` — Command/response names and basic decoding helpers.
			- `errors.dart` — Typed exceptions for DALI query/send/gateway/bus conditions.
			- `log.dart` — App-wide logging with levels and stream for UI.
			- `sequence.dart` — Sequenced or batch operations abstractions.
			- `sequence_store.dart` — Storage/management for saved sequences.
		- `pages/` — UI pages/screens (e.g., settings, home, login, short address manager); navigation-safe and localized.
		- `widgets/` — Reusable UI components with clear props; keep page-specific logic out.
		- `utils/` — Shared helpers (formatters, validators, error handling, extensions, light services without UI).
		- `custom_keys/` — Shared constants/keys (e.g., storage keys, feature flags).
	- `assets/` — App assets
		- `icon/` — App icons
		- `translations/` — i18n JSONs (e.g., `en.json`, `zh-CN.json`)
	- `android/`, `ios/`, `macos/`, `linux/`, `windows/`, `web/` — Platform targets
	- `test/` — Flutter tests
	- `server/` — Backend service (independent Go project)
		- `Dockerfile` — Production image
		- `docker-compose.yml` — Local orchestration
		- `Makefile` — Build/test/lint/run/docker tasks
		- `dalitoolkit-server.service` — Systemd service unit example
		- `init-db.sql` — DB init/migrations for local/testing
		- `README.md`, `TODO.md` — Backend blueprint and notes
		- `bin/` — Built binaries or helper scripts
		- `cmd/` — Entrypoints for binaries (each subfolder is a main package, e.g., server)
		- `internal/` — Private app packages (not for external reuse)
		- `pkg/` — Reusable packages (could be imported by other services)
		- `test/` — Backend tests and test data
	- Config files — `pubspec.yaml`, `analysis_options.yaml`, `firebase.json`, `flutter_launcher_icons.yaml`
	- Tooling — `.github/` (prompts & guides), `.dart_tool/`, `.idea/`, `.gitmodules`

Conventions:
- Keep platform-specific changes scoped to their platform folders.
- Place new shared Dart utilities in `lib/utils/` and reusable UI in `lib/widgets/`.
- Update `assets/translations/` for user-facing text and run localization tooling if applicable.
 - Keep `lib/` self-contained and modular. Page-specific state stays in `pages/`; cross-cutting services/utilities go to `utils/`.
 - For backend changes in `server/`, prefer `internal/` for app-only packages and `pkg/` for reusable ones. New binaries belong under `cmd/<name>/`.
 - Always sync structural changes back to this document as part of the same PR.


# Do not use snackbar

Use toast notifications instead of snackbars for displaying brief messages to the user. Toasts are less intrusive and provide a better user experience.
